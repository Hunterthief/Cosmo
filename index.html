<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CosmoForge - Game Community</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
      --primary: #1a1a2e;
      --secondary: #16213e;
      --accent: #e94560;
      --light: #f8f1f1;
      --gold: #d4af37;
    }

    [dir="rtl"] {
      direction: rtl;
      text-align: right;
    }

    body {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--light);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid var(--gold);
      margin-bottom: 30px;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--gold);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .lang-toggle {
      background: var(--gold);
      color: var(--primary);
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .lang-toggle:hover {
      background: var(--accent);
      color: white;
    }

    nav {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .tab {
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab.active {
      background: var(--gold);
      color: var(--primary);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .game-info {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .main-image-container {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .main-image {
      max-width: 100%;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.4);
      border: 3px solid var(--gold);
    }

    .details-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .game-description {
      padding: 25px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      align-self: start;
    }

    .game-description h2 {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 2rem;
    }

    .price {
      font-size: 2.5rem;
      color: var(--accent);
      margin: 20px 0;
      font-weight: bold;
    }

    .secondary-image-container {
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .secondary-image {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 15px;
    }

    .community-section {
      padding: 30px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 20px;
    }

    .upload-section {
      margin-bottom: 30px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
    }

    .upload-title {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 1.8rem;
    }

    .file-input {
      display: none;
    }

    .upload-btn {
      background: var(--gold);
      color: var(--primary);
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      display: inline-block;
    }

    .upload-btn:hover {
      background: var(--accent);
      color: white;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .photo-card {
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      position: relative;
      height: 300px;
      background: #0f0f19;
      display: flex;
      flex-direction: column;
    }

    .photo-like {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .photo-like:hover {
      transform: scale(1.1);
    }

    .photo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      flex: 1 1 auto;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
      color: var(--gold);
    }

    .error {
      text-align: center;
      padding: 20px;
      color: var(--accent);
      font-weight: bold;
    }

    .info-message {
      text-align: center;
      padding: 20px;
      color: var(--gold);
      font-style: italic;
      grid-column: 1 / -1;
    }

    .post-meta {
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .uploader-name { color: var(--light); font-size: 0.9rem; opacity: 0.9; }
    .post-time { color: rgba(255,255,255,0.6); font-size: 0.85rem; }

    @media (max-width: 900px) {
      .details-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      nav {
        flex-direction: column;
      }
      
      .tab {
        text-align: center;
      }
      
      .details-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" data-key="logo">CosmoForge</div>
      <button class="lang-toggle" id="langToggle">AR</button>
    </header>

    <nav>
      <div class="tab active" data-tab="main" data-key="gameInfoTab">Game Info</div>
      <div class="tab" data-tab="community" data-key="communityTab">Community</div>
    </nav>

    <div id="main" class="content-section active">
      <div class="game-info">
        <div class="main-image-container">
          <img class="main-image" src="package.png" alt="CosmoForge Box Art">
        </div>
        
        <div class="details-container">
          <div class="game-description">
            <h2 data-key="gameTitle">CosmoForge</h2>
            <p data-key="lore">In the vast Cosmo Universe, seven ancient energies shape every world—Fire, Magic, Shadow, Nature, Crystal, Lumer, and Spirit. Players gather around the Penge as these energies awaken, revealing memories, emotions, and hidden strengths.</p>
            
            <div class="price" data-key="price">10,000 EGP</div>
            
            <ul style="padding-left: 20px; margin-top: 10px;">
              <li style="margin: 10px 0;">
                <strong data-key="feature1">7 Unique Planet Energies</strong><br>
                <span data-key="feature1Desc">Each planet reduces a different emotional energy and creates a completely new play experience.</span>
              </li>
              <li style="margin: 10px 0;">
                <strong data-key="feature2">Hidden Symbol Challenge Cards</strong><br>
                <span data-key="feature2Desc">Circular cards reveal secret symbols when in the Torch—unlocking tear missions, emotional prompts and teams</span>
              </li>
              <li style="margin: 10px 0;">
                <strong data-key="feature3">Fast, Social, Competitive Fun</strong><br>
                <span data-key="feature3Desc">Teams race to complete challenges, earn pieces, and build their cosmic creation before the other team.</span>
              </li>
              <li style="margin: 10px 0;">
                <strong data-key="feature4">A Creation That Lasts</strong><br>
                <span data-key="feature4Desc">Every session ends with a unique sculpture built by your team—a physical memory of your energy together.</span>
              </li>
            </ul>
          </div>
          
          <div class="secondary-image-container">
            <img class="secondary-image" src="game.png" alt="CosmoForge Packaging">
          </div>
        </div>
      </div>
    </div>

    <div id="community" class="content-section">
      <div class="community-section">
        <div class="upload-section">
          <h2 class="upload-title" data-key="communityTitle">Share Your CosmoForge Moments</h2>
          <p data-key="communityDesc">Upload your game photos and see what others are creating!</p>
          <input type="file" id="photoUpload" class="file-input" accept="image/*">
          <label for="photoUpload" class="upload-btn" data-key="uploadBtn">Upload Photo</label>
          <div style="margin-top:12px; color:rgba(255,255,255,0.8); font-size:0.9rem;">
            <label style="font-weight:600;">Name (optional):</label>
            <input id="uploaderName" type="text" placeholder="Anonymous" style="margin-left:8px; padding:6px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:white;">
          </div>
          <div style="margin-top:8px; color:rgba(255,255,255,0.7); font-size:0.85rem;">
            <span>Community photos are stored using JSONBin.io and imgbb.com (both free).</span>
          </div>
        </div>

        <div class="photo-grid" id="photoGrid">
          <div class="info-message" id="infoMessage">No photos yet. Be the first to share!</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Translation data
      const translations = {
        en: {
          logo: 'CosmoForge',
          gameInfoTab: 'Game Info',
          communityTab: 'Community',
          gameTitle: 'CosmoForge',
          lore: 'In the vast Cosmo Universe, seven ancient energies shape every world—Fire, Magic, Shadow, Nature, Crystal, Lumer, and Spirit. Players gather around the Penge as these energies awaken, revealing memories, emotions, and hidden strengths.',
          price: '10,000 EGP',
          feature1: '7 Unique Planet Energies',
          feature1Desc: 'Each planet reduces a different emotional energy and creates a completely new play experience.',
          feature2: 'Hidden Symbol Challenge Cards',
          feature2Desc: 'Circular cards reveal secret symbols when in the Torch—unlocking tear missions, emotional prompts and teams',
          feature3: 'Fast, Social, Competitive Fun',
          feature3Desc: 'Teams race to complete challenges, earn pieces, and build their cosmic creation before the other team.',
          feature4: 'A Creation That Lasts',
          feature4Desc: 'Every session ends with a unique sculpture built by your team—a physical memory of your energy together.',
          communityTitle: 'Share Your CosmoForge Moments',
          communityDesc: 'Upload your game photos and see what others are creating!',
          uploadBtn: 'Upload Photo',
          infoMessage: 'No photos yet. Be the first to share!',
          uploadError: 'Error uploading photo. Please try again.',
          likeError: 'Error updating likes. Please try again.',
          fileSizeError: 'File size too large. Please upload an image smaller than 1MB.',
          fileTypeError: 'Please upload an image file.',
          fetchError: 'Error fetching posts. Check your JSONBin configuration.'
        },
        ar: {
          logo: 'كوزموفورج',
          gameInfoTab: 'معلومات اللعبة',
          communityTab: 'المجتمع',
          gameTitle: 'كوزموفورج',
          lore: 'في الكون الواسع كوزمو، تشكل سبع طاقات قديمة كل عالم - نار، سحر، ظل، طبيعة، كريستال، لومر وروح. يجتمع اللاعبون حول بينغ مع استيقاظ هذه الطاقات، مكشوفة الذكريات والعواطف والقدرات الخفية.',
          price: '10,000 جنيه مصري',
          feature1: '7 طاقات كوكبية فريدة',
          feature1Desc: 'يقلل كل كوكب من طاقة عاطفية مختلفة ويخلق تجربة لعب جديدة تمامًا.',
          feature2: 'بطاقات تحدي الرموز المخفية',
          feature2Desc: 'تعرض البطاقات الدائرية رموزًا سرية عند وجودها في المشعل - مما يفتح مهام الدموع وتحفيزات العواطف والفرق',
          feature3: 'مرح اجتماعي وتنافسي سريع',
          feature3Desc: 'تسابق الفرق لإكمال التحديات، وكسب القطع، وبناء إبداعهم الكوني قبل الفريق الآخر.',
          feature4: 'إبداع يدوم',
          feature4Desc: 'ينتهي كل جلسة بتمثال فريد يبنيه فريقك - ذاكرة مادية لطاقتك معًا.',
          communityTitle: 'شارك لحظات كوزموفورج الخاصة بك',
          communityDesc: 'قم بتحميل صور لعبتك وانظر ما الذي يصنعه الآخرون!',
          uploadBtn: 'تحميل صورة',
          infoMessage: 'لا توجد صور بعد. كن أول من يشارك!',
          uploadError: 'خطأ في تحميل الصورة. يرجى المحاولة مرة أخرى.',
          likeError: 'خطأ في تحديث الإعجابات. يرجى المحاولة مرة أخرى.',
          fileSizeError: 'حجم الملف كبير جدًا. يرجى تحميل صورة أصغر من 1 ميجابايت.',
          fileTypeError: 'يرجى تحميل ملف صورة.',
          fetchError: 'خطأ في جلب المنشورات. تحقق من تكوين JSONBin.'
        }
      };

      // Language toggle functionality
      const langToggle = document.getElementById('langToggle');
      const htmlElement = document.documentElement;
      let currentLang = 'en';
      const photoGrid = document.getElementById('photoGrid');
      const infoMessage = document.getElementById('infoMessage');

      // ✅ YOUR JSONBIN.IO CONFIGURATION ✅
      const JSONBIN_BIN_ID = "6939ce65ae596e708f90db24";
      const JSONBIN_SECRET_KEY = "$2a$10$XrpokQnnQEs7KTkuuGU.SugRPerfYquGH0BR/QJ.NfQJ1GQAoqsbC";
      
      // imgbb API key (keep this working)
      const IMGBB_API_KEY = '97cd51bcdaad92653ae70c44b18be538';

      // JSONBin.io API URLs
      const JSONBIN_READ_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`;
      const JSONBIN_WRITE_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

      // End CONFIG

      // Community storage key (local fallback)
      const STORAGE_KEY = 'cosmoCommunityPhotos_local';

      function updateLanguage(lang) {
        // Update document attributes
        htmlElement.setAttribute('lang', lang);
        htmlElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
        
        // Update all translatable elements
        document.querySelectorAll('[data-key]').forEach(el => {
          const key = el.getAttribute('data-key');
          if (translations[lang][key]) {
            el.textContent = translations[lang][key];
          }
        });
        
        // Update info message
        infoMessage.textContent = translations[lang].infoMessage;
        
        // Update language toggle button
        langToggle.textContent = lang === 'en' ? 'AR' : 'EN';
      }

      langToggle.addEventListener('click', function() {
        currentLang = currentLang === 'en' ? 'ar' : 'en';
        updateLanguage(currentLang);
      });

      // Initialize with English
      updateLanguage(currentLang);

      // Tab navigation
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          const targetTab = this.getAttribute('data-tab');
          document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
          });
          document.getElementById(targetTab).classList.add('active');
          
          // If community tab is activated, load posts
          if (targetTab === 'community') {
            startPollingPosts();
            loadPosts();
          } else {
            stopPollingPosts();
          }
        });
      });

      // ✅ JSONBIN.IO FUNCTIONS ✅
      async function fetchRemotePosts() {
        try {
          const response = await fetch(JSONBIN_READ_URL, {
            headers: {
              'X-Master-Key': JSONBIN_SECRET_KEY
            },
            cache: 'no-store'
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          return data.record || []; // JSONBin returns data in .record field
        } catch (err) {
          console.error('fetchRemotePosts error', err);
          return null;
        }
      }

      async function writeRemotePosts(posts) {
        try {
          const response = await fetch(JSONBIN_WRITE_URL, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-Master-Key': JSONBIN_SECRET_KEY,
              'X-Bin-Private': 'true'
            },
            body: JSON.stringify({ record: posts }) // JSONBin expects data in .record field
          });
          
          return response.ok;
        } catch (err) {
          console.error('writeRemotePosts error', err);
          return false;
        }
      }

      function getLocalPosts() {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }
      
      function setLocalPosts(posts) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
      }

      // Merge remote & local (remote has priority for shared view)
      async function getAllPosts() {
        const remote = await fetchRemotePosts();
        if (remote === null) {
          // remote fetch failed -> fallback to local
          return getLocalPosts();
        }
        // remote fetched successfully -> use it (and keep a local copy)
        setLocalPosts(remote);
        return remote;
      }

      // Render posts into grid (preserves existing styles)
      async function loadPosts() {
        try {
          const posts = await getAllPosts();
          // Clear grid
          photoGrid.innerHTML = '';
          if (!posts || posts.length === 0) {
            photoGrid.innerHTML = `<div class="info-message">${translations[currentLang].infoMessage}</div>`;
            return;
          }
          // Build cards
          posts.forEach(post => {
            const card = document.createElement('div');
            card.className = 'photo-card';
            card.innerHTML = `
              <img class="photo-image" src="${post.url}" alt="Community photo">
              <div class="post-meta">
                <div>
                  <div class="uploader-name">${post.uploader ? escapeHtml(post.uploader) : ''}</div>
                  <div class="post-time">${timeAgo(post.created_at)}</div>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <div style="color:var(--gold); font-weight:700;">${post.likes || 0} ❤️</div>
                  <button class="photo-like" data-id="${post.id}" title="Like">+</button>
                </div>
              </div>
            `;
            photoGrid.appendChild(card);
          });

          // Wire up like buttons
          document.querySelectorAll('.photo-like').forEach(btn => {
            btn.addEventListener('click', async function(e) {
              e.stopPropagation();
              const id = this.getAttribute('data-id');
              await likePost(id);
            });
          });
        } catch (err) {
          console.error('Error loading posts', err);
          photoGrid.innerHTML = `<div class="error">${translations[currentLang].fetchError}</div>`;
        }
      }

      // Like post (works remote)
      let likeLock = false;
      async function likePost(id) {
        if (likeLock) return;
        likeLock = true;
        try {
          // remote flow: fetch, update, write
          const remote = await fetchRemotePosts();
          if (remote === null) { likeLock = false; return; }
          const posts = Array.isArray(remote) ? remote : [];
          const idx = posts.findIndex(x => String(x.id) === String(id));
          if (idx === -1) { likeLock = false; return; }
          posts[idx].likes = (posts[idx].likes || 0) + 1;
          // write back
          const ok = await writeRemotePosts(posts);
          if (ok) {
            // update local copy & UI
            setLocalPosts(posts);
            loadPosts();
          } else {
            alert(translations[currentLang].likeError);
          }
        } catch (err) {
          console.error('likePost error', err);
          alert(translations[currentLang].likeError);
        } finally {
          likeLock = false;
        }
      }

      // Upload image: to imgbb (requires API key). We send base64 (strip data: prefix)
      async function uploadToImgbb(base64Data) {
        if (!IMGBB_API_KEY) return null;
        try {
          // base64Data includes "data:image/...;base64,..." -> strip header
          const parts = base64Data.split(',');
          const payload = parts.length > 1 ? parts[1] : parts[0];
          const form = new FormData();
          form.append('image', payload);
          // optional: name field
          form.append('name', 'cosmoforge_' + Date.now());
          const res = await fetch('https://api.imgbb.com/1/upload?key=' + encodeURIComponent(IMGBB_API_KEY), {
            method: 'POST',
            body: form
          });
          const json = await res.json();
          if (json && json.success && json.data && json.data.url) return json.data.url;
          console.error('imgbb upload failed', json);
          return null;
        } catch (err) {
          console.error('uploadToImgbb error', err);
          return null;
        }
      }

      // Create new post (upload -> write to jsonbin)
      const photoUpload = document.getElementById('photoUpload');
      const uploaderNameInput = document.getElementById('uploaderName');

      photoUpload.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];

          // Check file size (limit to 1MB)
          if (file.size > 1000000) {
            alert(translations[currentLang].fileSizeError);
            return;
          }

          // Check file type
          if (!file.type.match('image.*')) {
            alert(translations[currentLang].fileTypeError);
            return;
          }

          const reader = new FileReader();
          reader.onloadend = async function() {
            const base64Image = reader.result;

            try {
              // Upload to imgbb
              const imageUrl = await uploadToImgbb(base64Image);
              if (!imageUrl) {
                alert(translations[currentLang].uploadError);
                return;
              }

              // prepare new post
              const newPost = {
                id: Date.now() + Math.floor(Math.random()*1000),
                url: imageUrl,
                likes: 0,
                uploader: uploaderNameInput.value ? uploaderNameInput.value.trim() : '',
                created_at: new Date().toISOString()
              };

              // fetch current remote, add to top, write back
              const remote = await fetchRemotePosts();
              const posts = Array.isArray(remote) ? remote : [];
              posts.unshift(newPost);
              const ok = await writeRemotePosts(posts);
              if (!ok) {
                alert(translations[currentLang].uploadError);
                return;
              }
              // update local copy & UI
              setLocalPosts(posts);
              loadPosts();

              // Clear file input and name field
              photoUpload.value = '';
              uploaderNameInput.value = '';

            } catch (error) {
              console.error('Error uploading photo:', error);
              alert(translations[currentLang].uploadError);
            }
          };

          reader.readAsDataURL(file);
        }
      });

      // Polling to get remote updates (near realtime)
      let pollHandle = null;
      function startPollingPosts() {
        if (pollHandle) return;
        // initial load
        loadPosts();
        // poll every 3 seconds
        pollHandle = setInterval(() => {
          loadPosts();
        }, 3000);
      }
      function stopPollingPosts() {
        if (pollHandle) { clearInterval(pollHandle); pollHandle = null; }
      }

      // Time ago helper
      function timeAgo(iso) {
        try {
          const d = new Date(iso);
          const diff = Math.floor((Date.now() - d.getTime())/1000);
          if (diff < 60) return `${diff}s`;
          if (diff < 3600) return `${Math.floor(diff/60)}m`;
          if (diff < 86400) return `${Math.floor(diff/3600)}h`;
          return `${Math.floor(diff/86400)}d`;
        } catch (e) { return ''; }
      }

      // small safety: escape text
      function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
      }

      // initial load if community active
      if (document.getElementById('community').classList.contains('active')) {
        startPollingPosts();
        loadPosts();
      }

    });
  </script>
</body>
</html>
